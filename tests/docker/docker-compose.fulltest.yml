# Full-stack integration testing infrastructure
# Includes all services needed to test every feature of genro-mail-proxy

services:
  # ============================================
  # DATABASE
  # ============================================
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: mailproxy
      POSTGRES_PASSWORD: testpassword
      POSTGRES_DB: mailproxy
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mailproxy"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - testnet

  # ============================================
  # OBJECT STORAGE (S3-compatible)
  # ============================================
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - testnet

  # MinIO initial setup (create bucket)
  minio-setup:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 minioadmin minioadmin;
        mc mb local/mail-attachments --ignore-existing;
        mc anonymous set download local/mail-attachments;
        echo 'MinIO setup complete';
      "
    networks:
      - testnet

  # ============================================
  # SMTP SERVERS (MailHog)
  # ============================================
  mailhog-tenant1:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI / API
    networks:
      - testnet

  mailhog-tenant2:
    image: mailhog/mailhog:latest
    ports:
      - "1026:1025"   # SMTP
      - "8026:8025"   # Web UI / API
    networks:
      - testnet

  # ============================================
  # ERROR-SIMULATING SMTP SERVERS
  # ============================================

  # Rejects all emails (550 permanent error)
  smtp-reject:
    build:
      context: ./error-smtp
    ports:
      - "1027:1025"
    environment:
      - SMTP_ERROR_MODE=reject_all
    networks:
      - testnet

  # Temporary failures (451) - triggers retry
  smtp-tempfail:
    build:
      context: ./error-smtp
    ports:
      - "1028:1025"
    environment:
      - SMTP_ERROR_MODE=temp_fail
    networks:
      - testnet

  # Slow responses (simulates timeout)
  smtp-timeout:
    build:
      context: ./error-smtp
    ports:
      - "1029:1025"
    environment:
      - SMTP_ERROR_MODE=timeout
      - SMTP_TIMEOUT_SECONDS=30
    networks:
      - testnet

  # Rate limiting (accepts first N, then rejects)
  smtp-ratelimit:
    build:
      context: ./error-smtp
    ports:
      - "1030:1025"
    environment:
      - SMTP_ERROR_MODE=rate_limit
      - SMTP_RATE_LIMIT=3
    networks:
      - testnet

  # Random errors (mix of success/failure)
  smtp-random:
    build:
      context: ./error-smtp
    ports:
      - "1031:1025"
    environment:
      - SMTP_ERROR_MODE=random
    networks:
      - testnet

  # ============================================
  # IMAP SERVER (for bounce detection testing)
  # ============================================
  dovecot:
    image: dovecot/dovecot:2.4.0
    platform: linux/arm64
    user: root
    ports:
      - "10143:31143"
    volumes:
      - ./dovecot/etc:/etc/dovecot:ro
      - dovecot-mail:/srv/vmail
    healthcheck:
      test: ["CMD-SHELL", "doveadm auth test bounces@localhost bouncepass || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - testnet

  # ============================================
  # CLIENT ENDPOINTS (Echo servers for delivery reports)
  # ============================================
  client-tenant1:
    image: mendhak/http-https-echo:latest
    ports:
      - "8081:8080"
    environment:
      - HTTP_PORT=8080
    networks:
      - testnet

  client-tenant2:
    image: mendhak/http-https-echo:latest
    ports:
      - "8082:8080"
    environment:
      - HTTP_PORT=8080
    networks:
      - testnet

  # ============================================
  # ATTACHMENT SERVER (HTTP endpoint for remote attachments)
  # ============================================
  attachment-server:
    image: python:3.11-slim
    working_dir: /data
    command: python -m http.server 8080
    volumes:
      - ./test-attachments:/data:ro
    ports:
      - "8083:8080"
    networks:
      - testnet

  # ============================================
  # MAIL-PROXY SERVICE
  # ============================================
  mailproxy:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test
    image: genro-mail-proxy:test
    environment:
      - GMP_DB_PATH=postgresql://mailproxy:testpassword@db:5432/mailproxy
      - GMP_API_TOKEN=test-api-token
      # S3 configuration for large files
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_ENDPOINT_URL=http://minio:9000
      # Bounce detection configuration
      - GMP_BOUNCE_ENABLED=1
      - GMP_BOUNCE_IMAP_HOST=dovecot
      - GMP_BOUNCE_IMAP_PORT=31143
      - GMP_BOUNCE_IMAP_USER=bounces@localhost
      - GMP_BOUNCE_IMAP_PASSWORD=bouncepass
      - GMP_BOUNCE_POLL_INTERVAL=2
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      mailhog-tenant1:
        condition: service_started
      mailhog-tenant2:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - testnet

networks:
  testnet:
    driver: bridge

volumes:
  pgdata:
  minio-data:
  dovecot-mail:
