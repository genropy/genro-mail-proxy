# Full-stack integration testing infrastructure
#
# This compose provides the EXTERNAL INFRASTRUCTURE for fullstack tests:
# - Database (PostgreSQL)
# - SMTP servers (MailHog for capturing emails)
# - S3 storage (MinIO)
# - IMAP server (Dovecot for bounce testing)
# - Error-simulating SMTP servers
# - Echo servers (simulate client webhooks)
#
# The mailproxy service itself runs LOCALLY (not in Docker).
# This allows testing against current code without rebuilding containers.
#
# Usage:
#   1. Start infrastructure: docker compose -f docker-compose.fulltest.yml up -d
#   2. Start mailproxy locally:
#      GMP_DB_PATH=postgresql://mailproxy:testpassword@localhost:5433/mailproxy \
#      GMP_API_TOKEN=test-api-token \
#      uvicorn mail_proxy.server:app --host 0.0.0.0 --port 8000
#   3. Run tests: pytest tests/fullstack/
#   4. For bounce tests: docker compose --profile bounce up -d
#
# Note: PostgreSQL uses port 5433 (not 5432) to avoid conflicts with local postgres

services:
  # ============================================
  # DATABASE
  # ============================================
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: mailproxy
      POSTGRES_PASSWORD: testpassword
      POSTGRES_DB: mailproxy
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Use 5433 to avoid conflict with local postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mailproxy"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - testnet

  # ============================================
  # OBJECT STORAGE (S3-compatible)
  # ============================================
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - testnet

  # MinIO initial setup (create bucket)
  minio-setup:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 minioadmin minioadmin;
        mc mb local/mail-attachments --ignore-existing;
        mc anonymous set download local/mail-attachments;
        echo 'MinIO setup complete';
      "
    networks:
      - testnet

  # ============================================
  # SMTP SERVERS (MailHog)
  # ============================================
  mailhog-tenant1:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI / API
    networks:
      - testnet

  mailhog-tenant2:
    image: mailhog/mailhog:latest
    ports:
      - "1026:1025"   # SMTP
      - "8026:8025"   # Web UI / API
    networks:
      - testnet

  # ============================================
  # ERROR-SIMULATING SMTP SERVERS
  # ============================================

  # Rejects all emails (550 permanent error)
  smtp-reject:
    build:
      context: ./error-smtp
    ports:
      - "1027:1025"
    environment:
      - SMTP_ERROR_MODE=reject_all
    networks:
      - testnet

  # Temporary failures (451) - triggers retry
  smtp-tempfail:
    build:
      context: ./error-smtp
    ports:
      - "1028:1025"
    environment:
      - SMTP_ERROR_MODE=temp_fail
    networks:
      - testnet

  # Slow responses (simulates timeout)
  smtp-timeout:
    build:
      context: ./error-smtp
    ports:
      - "1029:1025"
    environment:
      - SMTP_ERROR_MODE=timeout
      - SMTP_TIMEOUT_SECONDS=30
    networks:
      - testnet

  # Rate limiting (accepts first N, then rejects)
  smtp-ratelimit:
    build:
      context: ./error-smtp
    ports:
      - "1030:1025"
    environment:
      - SMTP_ERROR_MODE=rate_limit
      - SMTP_RATE_LIMIT=3
    networks:
      - testnet

  # Random errors (mix of success/failure)
  smtp-random:
    build:
      context: ./error-smtp
    ports:
      - "1031:1025"
    environment:
      - SMTP_ERROR_MODE=random
    networks:
      - testnet

  # ============================================
  # IMAP SERVER (for bounce detection testing)
  # Only started with: docker compose --profile bounce up -d
  # ============================================
  dovecot:
    image: dovecot/dovecot:2.4.0
    platform: linux/arm64
    user: root
    profiles:
      - bounce
    ports:
      - "10143:31143"
    volumes:
      - ./dovecot/etc:/etc/dovecot:ro
      - dovecot-mail:/srv/vmail
    healthcheck:
      test: ["CMD-SHELL", "doveadm auth test bounces@localhost bouncepass || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - testnet

  # ============================================
  # CLIENT ENDPOINTS (Echo servers for delivery reports)
  # ============================================
  client-tenant1:
    image: mendhak/http-https-echo:latest
    ports:
      - "8081:8080"
    environment:
      - HTTP_PORT=8080
    networks:
      - testnet

  client-tenant2:
    image: mendhak/http-https-echo:latest
    ports:
      - "8082:8080"
    environment:
      - HTTP_PORT=8080
    networks:
      - testnet

  # ============================================
  # ATTACHMENT SERVER (HTTP endpoint for remote attachments)
  # ============================================
  attachment-server:
    image: python:3.11-slim
    working_dir: /data
    command: python -m http.server 8080
    volumes:
      - ./test-attachments:/data:ro
    ports:
      - "8083:8080"
    networks:
      - testnet

networks:
  testnet:
    driver: bridge

volumes:
  pgdata:
  minio-data:
  dovecot-mail:
