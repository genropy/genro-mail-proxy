
API Reference
=============

FastAPI
-------

The REST API is served by FastAPI.  The automatically generated documentation
is available at:

* OpenAPI JSON: ``http://localhost:8000/openapi.json``
* Swagger UI: ``http://localhost:8000/docs``
* ReDoc: ``http://localhost:8000/redoc``

All endpoints require the ``X-API-Token`` header when
``[server] api_token`` (or ``API_TOKEN``) is configured.

Core endpoints
--------------

``POST /commands/run-now``
   Immediately trigger a fetch/delivery cycle.

``POST /commands/suspend`` / ``POST /commands/activate``
   Toggle the scheduler.

``POST /commands/send-message``
   Send a single message now, bypassing the queue.

``POST /commands/add-messages``
   Enqueue a batch of messages for the scheduler.  Each payload entry matches
   :class:`async_mail_service.api.SendMessagePayload`.

``POST /commands/rules`` / ``PATCH`` / ``DELETE`` / ``GET``
   CRUD operations for scheduling rules.  Entries are described by
   :class:`async_mail_service.api.RulePayload`.

``POST /account`` / ``GET /accounts`` / ``DELETE /account/{id}``
   Manage SMTP account credentials.

``GET /pending`` / ``GET /deferred``
   Inspect messages currently in the pending or deferred queues.

``GET /metrics``
   Expose Prometheus metrics generated by
   :class:`async_mail_service.prometheus.MailMetrics`.

Prometheus metrics
------------------

The following metrics are exported:

* ``asyncmail_sent_total{account_id}``
* ``asyncmail_errors_total{account_id}``
* ``asyncmail_deferred_total{account_id}``
* ``asyncmail_rate_limited_total{account_id}``
* ``asyncmail_pending_messages``
